# 互斥和同步

## 互斥

多线程之间需要有互斥保护共享着的资源

* 自旋锁
  
  * 概念：自旋锁（spin lock） 是一种典型的对临界资源进行互斥访问的手段，`主要针对的是SMP以及单CPU但是内核可抢占的情况`
    
    * 这里注意如果是单CPU，一定需要内核可抢占，不然会一直自旋，死等了
  
  * 如果锁被占用了，即会进行自旋，死等
  
  * 实际上自旋锁一般的实现是：
    
    * 测试并设置，test_and_set
    
    * 比较并交换，compare_and_swap
    
    * 总的来说动作是load_and_store，即先读再写，并且load和store的动作是原子操作
  
  * 优势：
    
    * 上下文切换开销低，线程不挂起/唤醒
  
  * 缺点：
    
    * 单核CPU不适合，有可能死锁
    
    * 如果临界区过长，会浪费CPU时间
  
  * 综上
    
    * 自旋锁适合，`短临界区、多核系统`

* 互斥锁

* 总结：

| 特性    | 自旋锁 spin_lock | 互斥锁 mutex   |
| ----- | ------------- | ----------- |
| 是否阻塞  | 不阻塞，忙等待       | 阻塞，线程进入休眠状态 |
| 适用场景  | 短临界区、多核系统     | 任意长度临界区     |
| 上下文开销 | 无             | 有           |



## 同步

生产者消费者问题，使用信号量、条件变量、互斥锁都可以实现同步


